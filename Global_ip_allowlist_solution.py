import csv
import io
import json
from datetime import datetime


class mySolution:
    def global_ip_allowlist(self, Current_state, Validator_state) -> list:
        
        # Parse the CSV formated data into dictionariessssssssss
        Current_state_reader = csv.DictReader(io.StringIO(Current_state))
        Validator_input_reader = csv.DictReader(io.StringIO(Validator_state))

        # we can access individual elements of dictionary current_state
        #for row in Current_state_reader:
        #   print(row["bot_id"])

        # same can be true with validatorrrrrrrrrrrrr, lets check it out
        #for address in Validator_input_reader:
        #   print(address["address"])

        # nwo, we will convert current state to dictionary for easier lookup
        Current_state_dict = {}
        for row in Current_state_reader:
            address = row["address"]
            bot_id = int(row["bot_id"])

            # lets create a composite key using bot_id & address
            key = f"{bot_id}:{address}"
            Current_state_dict[key] = {
                "id": int(row["id"]),
                "bot_id": bot_id,
                "address": address,
                "created_at": row["created_at"],
                "updated_at": row["updated_at"],
                "deleted_at": row["deleted_at"]
            }

            
        # convertttt validator input to a set for checking existence
        validator_set = set()
        validator_dict = {}
        for row in Validator_input_reader:
            address = row["address"]
            bot_id = int(row["bot_id"])
            key = f"{bot_id}:{address}"
            validator_set.add(key)
            validator_dict[key] = {
                "bot_id": bot_id,
                "address": address
            }

        # current timestamps for updates
        Current_timestamps = datetime.utcnow().strftime("%Y-%m-%d %H:%M:%S.%f+00")

        # output list
        output = []

        # check for updates and deletes from current state
        for key, item in Current_state_dict.items():
            if key in validator_set:
                # Rule 2 & 4: IP exists in both lists or was deleted but now exists again
                status = "UPDATE"
                output.append(
                    {
                        "id": item["id"],
                        "bot_id": item["bot_id"],
                        "address": item["address"],
                        "status": status,
                        "updated_at": Current_timestamps
                    }
                )
            else:
                # Rule 1: IP exists in current state but not in validator input
                status = "DELETE"
                output.append(
                    {
                        "id": item["id"],
                        "bot_id": item["bot_id"],
                        "address": item["address"],
                        "status": status,
                        "updated_at": Current_timestamps
                    }
                )
        
        # now in order to check fo rnew ips, we shall check them in validator input
        for key in validator_set:
            if key not in Current_state_dict:
                # Rule 3: ip does not exist in current state but is in validator input
                validator_item = validator_dict[key]
                # Generate a unique ID for new entries (this is just for demonstration)
                # In a real system, you might use a database to generate a new ID
                new_id = len(output) + 1000000 # jsut a placeholder approach
                status = "CREATE"
                output.append(
                    {
                        "id": new_id,
                        "bot_id": validator_item["bot_id"],
                        "address": validator_item["address"],
                        "status": status,
                        "updated_at": Current_timestamps
                    }
                )
        return output

def main():
    # Current state data
    CURRENT_STATE = '''"id","bot_id","address","created_at","updated_at","deleted_at"
    272747,133,"20.191.45.212/32","2021-05-03 19:38:32.502171+00","2021-09-15 15:55:45.463072+00",
    29172,133,"50.16.241.114/32","2019-08-27 22:38:08.081476+00","2021-09-15 15:55:45.463074+00",
    29177,133,"23.21.227.69/32","2019-08-27 22:38:08.081476+00","2021-09-15 15:55:45.463073+00",
    29178,133,"50.16.241.117/32","2019-08-27 22:38:08.081476+00","2021-09-15 15:55:45.463075+00",
    148244,133,"40.88.21.235/32","2020-04-16 23:52:27.942766+00","2021-09-15 15:55:45.463073+00",
    29171,133,"50.16.241.113/32","2019-08-27 22:38:08.081476+00","2021-09-15 15:55:45.463074+00",
    29174,133,"52.204.97.54/32","2019-08-27 22:38:08.081476+00","2021-09-15 15:55:45.463076+00",
    29173,133,"50.16.247.234/32","2019-08-27 22:38:08.081476+00","2021-09-15 15:55:45.463075+00",
    84993,133,"54.208.102.37/32","2019-11-15 22:50:49.517137+00","2021-09-15 15:55:45.463077+00",
    29175,133,"52.5.190.19/32","2019-08-27 22:38:08.081476+00","2021-09-15 15:55:45.463076+00",
    29176,133,"54.197.234.188/32","2019-08-27 22:38:08.081476+00","2021-09-15 15:55:45.463077+00",
    84994,133,"107.21.1.8/32","2019-11-15 22:50:49.517137+00","2021-09-15 15:55:45.463078+00",
    29179,133,"54.208.100.253/32","2019-08-27 22:38:08.081476+00","2021-09-15 15:55:45.463077+00",
    6368,52,"123.125.71.109/32","2019-08-14 21:37:35.58665+00","2021-09-16 04:01:50.125878+00",
    263728,52,"116.179.37.247/32","2021-04-08 23:59:17.495196+00","2021-09-16 04:00:12.605532+00",
    6466,52,"220.181.108.102/32","2019-08-14 21:37:35.58665+00","2021-09-16 03:59:31.217762+00",
    149950,52,"116.179.32.119/32","2020-05-07 18:04:21.301992+00","2021-09-16 04:01:48.370977+00",
    145427,52,"116.179.32.46/32","2020-03-27 06:42:12.812022+00","2021-09-16 04:00:52.15177+00",
    263741,52,"116.179.37.9/32","2021-04-08 23:59:17.495196+00","2021-09-16 04:01:22.703607+00",
    6232,52,"180.76.15.139/32","2019-08-14 21:37:35.58665+00","2021-09-16 04:01:06.410831+00",
    6320,52,"111.206.221.106/32","2019-08-14 21:37:35.58665+00","2021-09-16 04:00:26.176573+00",
    6513,52,"220.181.108.107/32","2019-08-14 21:37:35.58665+00","2021-09-16 04:00:55.96909+00",
    54178,52,"111.206.198.52/32","2019-09-25 14:40:32.265589+00","2021-09-16 16:07:25.277752+00",
    263773,52,"116.179.37.198/32","2021-04-08 23:59:17.495196+00","2021-09-16 04:01:05.658682+00",
    263769,52,"116.179.37.239/32","2021-04-08 23:59:17.495196+00","2021-09-16 16:07:32.266215+00",
    6212,52,"180.76.15.135/32","2019-08-14 21:37:35.58665+00","2021-09-16 04:01:03.803624+00",
    263737,52,"116.179.37.22/32","2021-04-08 23:59:17.495196+00","2021-09-16 16:07:30.588774+00",
    54126,52,"111.206.198.75/32","2019-09-25 13:34:24.457667+00","2021-09-16 04:00:49.472435+00",
    263636,52,"116.179.37.47/32","2021-04-08 23:59:17.495196+00","2021-09-16 04:01:27.14194+00",
    6452,52,"123.125.71.21/32","2019-08-14 21:37:35.58665+00","2021-09-16 04:01:45.174752+00",
    6312,52,"180.76.15.136/32","2019-08-14 21:37:35.58665+00","2021-09-16 04:01:22.64847+00",
    6408,52,"111.206.221.11/32","2019-08-14 21:37:35.58665+00","2021-09-16 16:07:44.795285+00",
    263595,52,"116.179.37.252/32","2021-04-08 23:59:17.495196+00","2021-09-16 16:07:45.80357+00",
    263649,52,"116.179.37.8/32","2021-04-08 23:59:17.495196+00","2021-09-16 04:01:43.899177+00",
    144908,52,"116.179.32.90/32","2020-03-26 10:33:13.76704+00","2021-09-16 16:07:52.028348+00",
    144906,52,"116.179.32.75/32","2020-03-26 10:33:13.76704+00","2021-09-16 04:00:04.271396+00",
    6464,52,"111.206.221.4/32","2019-08-14 21:37:35.58665+00","2021-09-16 04:00:58.080085+00",
    145010,52,"116.179.32.97/32","2020-03-27 00:28:12.7104+00","2021-09-16 16:07:23.425877+00",
    6519,52,"123.125.71.85/32","2019-08-14 21:37:35.58665+00","2021-09-16 04:01:48.682838+00",
    53546,52,"111.206.198.15/32","2019-09-25 03:45:11.687293+00","2021-09-16 04:01:29.982874+00",
    263758,52,"116.179.37.123/32","2021-04-08 23:59:17.495196+00","2021-09-16 16:07:15.479248+00",
    6418,52,"111.206.221.68/32","2019-08-14 21:37:35.58665+00","2021-09-16 04:01:18.58223+00",
    145458,52,"116.179.32.239/32","2020-03-27 06:42:12.812022+00","2021-09-16 04:01:22.281878+00",
    6486,52,"180.76.15.34/32","2019-08-14 21:37:35.58665+00","2021-09-16 04:01:48.147919+00",
    6208,52,"123.125.71.18/32","2019-08-14 21:37:35.58665+00","2021-09-16 04:01:28.845323+00",
    145002,52,"116.179.32.223/32","2020-03-26 22:29:15.978035+00","2021-09-16 03:59:25.783465+00",
    263608,52,"116.179.37.134/32","2021-04-08 23:59:17.495196+00","2021-09-16 16:07:11.762382+00",
    263625,52,"116.179.37.86/32","2021-04-08 23:59:17.495196+00","2021-09-16 03:59:48.028962+00",
    6224,52,"111.206.221.20/32","2019-08-14 21:37:35.58665+00","2021-09-16 16:07:52.971673+00",
    6225,52,"220.181.108.111/32","2019-08-14 21:37:35.58665+00","2021-09-16 03:59:42.573845+00",
    6275,52,"220.181.108.123/32","2019-08-14 21:37:35.58665+00","2021-09-16 16:07:09.394586+00",
    6370,52,"220.181.108.155/32","2019-08-14 21:37:35.58665+00","2021-09-16 16:07:39.429889+00",
    6510,52,"180.76.15.150/32","2019-08-14 21:37:35.58665+00","2021-09-16 04:01:26.655642+00",
    263730,52,"116.179.37.158/32","2021-04-08 23:59:17.495196+00","2021-09-16 03:59:38.194006+00",
    145466,52,"116.179.32.199/32","2020-03-27 06:42:12.812022+00","2021-09-16 03:59:22.008073+00",
    263709,52,"116.179.37.112/32","2021-04-08 23:59:17.495196+00","2021-09-16 16:06:58.503122+00",
    145447,52,"116.179.32.146/32","2020-03-27 06:42:12.812022+00","2021-09-16 04:00:59.091437+00",
    6503,52,"180.76.15.151/32","2019-08-14 21:37:35.58665+00","2021-09-16 04:01:20.175004+00",
    145442,52,"116.179.32.234/32","2020-03-27 06:42:12.812022+00","2021-09-16 03:59:58.88984+00",
    145478,52,"116.179.32.215/32","2020-03-27 07:42:03.399819+00","2021-09-16 16:08:09.509629+00",
    6509,52,"111.206.221.34/32","2019-08-14 21:37:35.58665+00","2021-09-16 04:01:01.269051+00",
    265658,52,"116.179.37.67/32","2021-04-22 14:51:47.09902+00","2021-09-16 03:59:45.225599+00",
    6207,52,"180.76.15.25/32","2019-08-14 21:37:35.58665+00","2021-09-16 04:01:26.968182+00",
    6204,52,"220.181.108.171/32","2019-08-14 21:37:35.58665+00","2021-09-16 16:07:41.465058+00",
    263594,52,"116.179.37.81/32","2021-04-08 23:59:17.495196+00","2021-09-16 04:00:02.298895+00",
    6335,52,"180.76.15.23/32","2019-08-14 21:37:35.58665+00","2021-09-16 04:01:20.557141+00",
    263764,52,"116.179.37.31/32","2021-04-08 23:59:17.495196+00","2021-09-16 16:07:59.226497+00",
    144864,52,"116.179.32.87/32","2020-03-26 07:33:32.952016+00","2021-09-16 03:59:42.947418+00",
    6345,52,"180.76.15.137/32","2019-08-14 21:37:35.58665+00","2021-09-16 04:01:16.993934+00",
    6435,52,"123.125.71.43/32","2019-08-14 21:37:35.58665+00","2021-09-16 04:01:45.549721+00",
    263611,52,"116.179.37.217/32","2021-04-08 23:59:17.495196+00","2021-09-16 04:00:54.19841+00",
    6379,52,"180.76.15.152/32","2019-08-14 21:37:35.58665+00","2021-09-16 04:01:00.569123+00",
    144959,52,"116.179.32.133/32","2020-03-26 13:39:29.565388+00","2021-09-16 03:59:25.425973+00",
    145468,52,"116.179.32.221/32","2020-03-27 07:42:03.399819+00","2021-09-16 16:07:51.530294+00",
    6322,52,"220.181.108.143/32","2019-08-14 21:37:35.58665+00","2021-09-16 04:00:50.934749+00",
    263613,52,"116.179.37.171/32","2021-04-08 23:59:17.495196+00","2021-09-16 03:59:22.87487+00",
    53553,52,"111.206.198.126/32","2019-09-25 03:45:11.687293+00","2021-09-16 16:07:01.094277+00",
    263719,52,"116.179.37.78/32","2021-04-08 23:59:17.495196+00","2021-09-16 16:07:04.299829+00",
    6511,52,"180.76.15.143/32","2019-08-14 21:37:35.58665+00","2021-09-16 04:01:13.145761+00",
    6244,52,"123.125.71.98/32","2019-08-14 21:37:35.58665+00","2021-09-16 04:01:42.522799+00",
    6294,52,"123.125.71.94/32","2019-08-14 21:37:35.58665+00","2021-09-16 04:01:13.136953+00",
    6369,52,"123.125.71.70/32","2019-08-14 21:37:35.58665+00","2021-09-16 04:01:11.295961+00",
    263654,52,"116.179.37.150/32","2021-04-08 23:59:17.495196+00","2021-09-16 03:59:07.969996+00",
    6386,52,"123.125.71.20/32","2019-08-14 21:37:35.58665+00","2021-09-16 04:01:33.207907+00",
    6211,52,"180.76.15.158/32","2019-08-14 21:37:35.58665+00","2021-09-16 04:01:50.071321+00",
    6364,52,"111.206.221.76/32","2019-08-14 21:37:35.58665+00","2021-09-16 04:01:00.313004+00",
    6344,52,"111.206.221.114/32","2019-08-14 21:37:35.58665+00","2021-09-16 16:07:49.759128+00",
    265278,52,"116.179.37.0/32","2021-04-16 07:48:59.138824+00","2021-09-16 03:59:29.045004+00",
    144911,52,"116.179.32.157/32","2020-03-26 10:33:13.76704+00","2021-09-16 16:07:50.395357+00",
    6349,52,"220.181.108.116/32","2019-08-14 21:37:35.58665+00","2021-09-16 04:01:48.430078+00",
    6524,52,"220.181.108.163/32","2019-08-14 21:37:35.58665+00","2021-09-16 16:07:43.435179+00",
    263694,52,"116.179.37.114/32","2021-04-08 23:59:17.495196+00","2021-09-16 16:06:58.395376+00",
    6387,52,"180.76.15.6/32","2019-08-14 21:37:35.58665+00","2021-09-16 04:01:42.525668+00",
    164478,52,"116.179.32.54/32","2020-06-22 10:06:15.226705+00","2021-09-16 04:00:57.114927+00",
    145473,52,"116.179.32.211/32","2020-03-27 07:42:03.399819+00","2021-09-16 03:59:01.134972+00",
    54167,52,"111.206.198.6/32","2019-09-25 14:40:32.265589+00","2021-09-16 16:07:28.814143+00",
    265657,52,"116.179.37.93/32","2021-04-22 14:51:47.09902+00","2021-09-16 04:00:19.222927+00",
    145482,52,"116.179.32.95/32","2020-03-27 07:42:03.399819+00","2021-09-16 04:00:16.840489+00",
    263766,52,"116.179.37.136/32","2021-04-08 23:59:17.495196+00","2021-09-16 03:59:01.695391+00",
    6376,52,"111.206.221.72/32","2019-08-14 21:37:35.58665+00","2021-09-16 16:07:22.409219+00",
    6268,52,"111.206.221.79/32","2019-08-14 21:37:35.58665+00","2021-09-16 04:00:52.437359+00",
    6410,52,"111.206.221.18/32","2019-08-14 21:37:35.58665+00","2021-09-16 04:00:32.273602+00",
    144916,52,"116.179.32.17/32","2020-03-26 10:33:13.76704+00","2021-09-16 04:01:02.973099+00",
    54181,52,"111.206.198.94/32","2019-09-25 14:40:32.265589+00","2021-09-16 04:01:14.825956+00",
    6424,52,"111.206.221.10/32","2019-08-14 21:37:35.58665+00","2021-09-16 16:07:01.340941+00",
    265645,52,"116.179.37.91/32","2021-04-22 14:51:47.09902+00","2021-09-16 03:59:25.666062+00",
    144940,52,"116.179.32.207/32","2020-03-26 12:40:15.486431+00","2021-09-16 04:01:32.143586+00",
    6270,52,"180.76.15.134/32","2019-08-14 21:37:35.58665+00","2021-09-16 04:01:21.802264+00",
    6241,52,"123.125.71.81/32","2019-08-14 21:37:35.58665+00","2021-09-16 04:01:19.738146+00",
    54184,52,"111.206.198.53/32","2019-09-25 14:40:32.265589+00","2021-09-16 04:01:25.028758+00",
    145464,52,"116.179.32.101/32","2020-03-27 06:42:12.812022+00","2021-09-16 16:07:22.182629+00",
    6396,52,"123.125.71.105/32","2019-08-14 21:37:35.58665+00","2021-09-16 04:01:26.269268+00",
    149957,52,"116.179.32.248/32","2020-05-07 18:04:21.301992+00","2021-09-16 04:01:14.850149+00"'''

    # Validator input data
    VALIDATOR_INPUT = '''"bot_id","address"
    133,"20.191.45.212/32"
    133,"50.16.241.114/32"
    133,"23.21.227.69/32"
    133,"50.16.241.117/32"
    133,"40.88.21.235/32"
    133,"50.16.241.113/32"
    133,"52.204.97.54/32"
    133,"50.16.247.234/32"
    133,"54.208.102.37/32"
    133,"52.5.190.21/32"
    133,"54.197.234.188/32"
    133,"107.21.1.3/32"
    133,"54.208.100.253/32"
    52,"123.125.71.109/32"
    52,"116.179.37.247/32"
    52,"220.181.108.102/32"
    52,"116.179.32.119/32"
    52,"116.179.32.46/32"
    52,"116.179.37.9/32"
    52,"180.76.15.139/32"
    52,"111.206.221.106/32"
    52,"220.181.108.107/32"
    52,"111.206.198.52/32"
    52,"116.179.37.198/32"
    52,"116.179.37.239/32"
    52,"180.76.15.135/32"
    52,"116.179.37.22/32"
    52,"111.206.198.75/32"
    52,"116.179.37.47/32"
    52,"123.125.71.21/32"
    52,"180.76.15.136/32"
    52,"111.206.221.11/32"
    52,"116.179.37.252/32"
    52,"116.179.37.8/32"
    52,"116.179.32.90/32"
    52,"116.179.32.75/32"
    52,"111.206.221.4/32"
    52,"116.179.32.97/32"
    52,"123.125.71.85/32"
    52,"111.206.198.15/32"
    52,"116.179.37.123/32"
    52,"111.206.221.68/32"
    52,"116.179.32.239/32"
    52,"180.76.15.34/32"
    52,"123.125.71.18/32"
    52,"116.179.32.223/32"
    52,"116.179.37.134/32"
    52,"116.179.37.86/32"
    52,"111.206.221.20/32"
    52,"220.181.108.111/32"
    52,"220.181.108.123/32"
    52,"220.181.108.155/32"
    52,"180.76.15.150/32"
    52,"116.179.37.158/32"
    52,"116.179.32.199/32"
    52,"116.179.37.112/32"
    52,"116.179.32.146/32"
    52,"180.76.15.151/32"
    52,"116.179.32.234/32"
    52,"116.179.32.215/32"
    52,"111.206.221.34/32"
    52,"116.179.37.67/32"
    52,"180.76.15.25/32"
    52,"220.181.108.171/32"
    52,"116.179.37.81/32"
    52,"180.76.15.23/32"
    52,"116.179.37.31/32"
    52,"116.179.32.87/32"
    52,"180.76.15.137/32"
    52,"123.125.71.43/32"
    52,"116.179.37.217/32"
    52,"180.76.15.152/32"
    52,"116.179.32.133/32"
    52,"116.179.32.221/32"
    52,"220.181.108.143/32"
    52,"116.179.37.171/32"
    52,"111.206.198.126/32"
    52,"116.179.37.78/32"
    52,"180.76.15.143/32"
    52,"123.125.71.98/32"
    52,"123.125.71.94/32"
    52,"123.125.71.70/32"
    52,"116.179.37.150/32"
    52,"123.125.71.20/32"
    52,"180.76.15.158/32"
    52,"111.206.221.76/32"
    52,"111.206.221.114/32"
    52,"116.179.37.0/32"
    52,"116.179.32.157/32"
    52,"220.181.108.116/32"
    52,"220.181.108.163/32"
    52,"116.179.37.114/32"
    52,"180.76.15.6/32"
    52,"116.179.32.54/32"
    52,"116.179.32.211/32"
    52,"111.206.198.6/32"
    52,"116.179.37.93/32"
    52,"116.179.32.95/32"
    52,"116.179.37.136/32"
    52,"111.206.221.72/32"
    52,"111.206.221.79/32"
    52,"111.206.221.18/32"
    52,"116.179.32.17/32"
    52,"111.206.198.94/32"
    52,"111.206.221.10/32"
    52,"116.179.37.91/32"
    52,"116.179.32.207/32"
    52,"180.76.15.134/32"
    52,"123.125.71.81/32"
    52,"111.206.198.53/32"
    52,"116.179.32.101/32"
    52,"123.125.71.105/32"
    52,"116.179.32.248/32"
    99,"10.0.0.1/32"
    07,"20.0.0.1/32"'''

    obj1 = mySolution()
    result = obj1.global_ip_allowlist(CURRENT_STATE, VALIDATOR_INPUT)

    print(json.dumps(result[:], indent=2))


if __name__ == "__main__":
    main()